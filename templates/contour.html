<!DOCTYPE html>
<html lang="en">
    <head>
        <title>CloudGen: A Simple Cloud of Points Generator</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<!--<link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">-->
		<link href="../static/css/style.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous">
		<script>
			// Declare variables for canvas, context, and image object
			var canvas, context, imageObj;
			var points = [];  																			// Array to store points clicked on the canvas.
			var scale  = 1;  																			// Scale factor for zoom.

			// Function to initialize canvas and load the image
			window.onload = function() {
				canvas   = document.getElementById('imageCanvas');
				context  = canvas.getContext('2d');
				imageObj = new Image();

				// When the image is loaded, draw it on the canvas
				imageObj.onload = function() {
					var vw = window.innerWidth / 100;
        			scale = (60 * vw) / imageObj.width;
					drawImage();  																		// Adjust the initial size of the canvas.
				};
				
				imageObj.src = "{{ url_for('uploaded_file', filename=filename) }}";  					// Set the source of the image.
			};

			// Function to draw the image on the canvas
			function drawImage() {
				canvas.width  = imageObj.width * scale;  												// Set canvas width based on image width and scale.
				canvas.height = imageObj.height * scale;  												// Set canvas height based on image height and scale.
				context.clearRect(0, 0, canvas.width, canvas.height);  									// Clear the canvas.
				context.drawImage(imageObj, 0, 0, canvas.width, canvas.height);  						// Draw the image.

				if (points.length > 0) {
					// Draw points and connect them with lines
					context.beginPath();
					context.moveTo(points[0].x * scale, points[0].y * scale);  							// Move to the position of the first point.
					for (var i = 1; i < points.length; i++) {
						context.lineTo(points[i].x * scale, points[i].y * scale);  						// Draw line to the next point.
						context.moveTo(points[i].x * scale, points[i].y * scale);  						// Move to the position of the next point.
					}
					context.strokeStyle = '#000000';
					context.lineWidth = 2;
					context.stroke();

					// Draw circles at each point
					points.forEach(p => {
						context.fillStyle = "#FF0000";
						context.beginPath();
						context.arc(p.x * scale, p.y * scale, 5, 0, 2 * Math.PI);  						// Draw a circle at the point.
						context.fill();
					});
				}
			}

			// Function to zoom in on the canvas
			function zoomIn() {
				scale *= 1.5;  																			// Increase the scale by 1.5.
				drawImage();  																			// Redraw the image with the new scale.
			}

			// Function to zoom out on the canvas
			function zoomOut() {
				scale /= 1.5;  																			// Decrease the scale by 1.5.
				drawImage();  																			// Redraw the image with the new scale.
			}

			// Function to reset the zoom level
			function resetZoom() {
				var vw = window.innerWidth / 100;
        		scale = (60 * vw) / imageObj.width;
				//scale = 1;  																			// Reset the scale to 1.
				drawImage();  																			// Redraw the image with the new scale.
			}

			// Function to get the click position on the canvas
			function getClickPosition(e) {
				var rect = canvas.getBoundingClientRect();  											// Get the bounding rectangle of the canvas.
				var xPosition = (e.clientX - rect.left) / scale;  										// Calculate the x position based on the scale.
				var yPosition = (e.clientY - rect.top) / scale;  										// Calculate the y position based on the scale.

				points.push({x: xPosition, y: yPosition});  											// Add the new point to the points array.
				drawImage();  																			// Redraw the image with the new point.
			}

			// Function to undo the last point added
			function undoLastPoint() {
				if (points.length > 0) {
					points.pop();  																		// Remove the last point from the points array.
					drawImage();  																		// Redraw the image without the last point.
				}
			}

			// Function to reset the canvas and clear all points
			function resetCanvas() {
				points = [];  																			// Clear the points array.
				drawImage();  																			// Redraw the image without any points.
			}

			// Function to download the points as a CSV file
			function downloadCSV() {
				// Normalize points based on the image dimensions
				const normalizedPoints = points.map(p => ({
					x: p.x / imageObj.width,
					y: (imageObj.height - p.y) / imageObj.height
				}));

				// Send a POST request to download the CSV file
				fetch('{{ url_for("download_csv") }}', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({points: normalizedPoints})  									// Send the normalized points in the request body.
				})
				.then(response => response.json())
				.then(data => {
					var filename = data.filename;  														// Get the filename from the server response.
					var url = '{{ url_for("static_files", filename="") }}' + filename;  				// Build the URL to the file.
					var a = document.createElement('a');  												// Create a temporary anchor element.
					a.href = url;
					a.download = filename;  															// Set the download attribute with the filename from the server.
					document.body.appendChild(a);
					a.click();  																		// Programmatically click the anchor to trigger the download.
					a.remove();  																		// Remove the anchor element from the document.
				})
				.catch((error) => {
					console.error('Error:', error);  													// Log any errors to the console.
				});
			}
		</script>
    </head>

    <body>
        <!-- Header -->
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="{{ url_for('index') }}" id="logo"><img src="../static/images/logo.png" alt="CloudGen Logo" height="60"/> mGFD: CloudGenerator</a>
	           	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    	           	<span class="navbar-toggler-icon"></span>
	       	    </button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a href="{{ url_for('index') }}" class="nav-link">Home</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('upload_image') }}" class="nav-link">ContourCreator</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('upload_files') }}" class="nav-link">CloudGenerator</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('modify') }}" class="nav-link">CloudMod</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('about') }}" class="nav-link">About</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('howto') }}" class="nav-link"><i class='fas fa-question-circle'></i></a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Main Contenedor -->
		<div id="main-wrapper">
	    	<!-- Main -->
    		<div id="main" class="container mt-4">
		        <div class="row main-row">
					<div id="workspace">
						<div id="canvas-actions-container">
							<div id="canvas-container" style="width:60vw; height:60vh; overflow:auto;">
								<canvas id="imageCanvas" onclick="getClickPosition(event)"></canvas>
							</div>
							<div id="action-buttons-canvas">
								<button id="original-size" onclick="resetZoom()"><i class='fas fa-expand-arrows-alt'></i></button>
								<button id="zoom-in" onclick="zoomIn()"><i class='fas fa-search-plus'></i></button>
								<button id="zoom-out" onclick="zoomOut()"><i class='fas fa-search-minus'></i></button>
								<button id="undo" onclick="undoLastPoint()"><i class='fas fa-undo'></i></button>
							</div>
						</div>
						<div id="action-buttons">
							<center>
								<button id="reset" onclick="resetCanvas()">Reset</button>
								<button id="download" onclick="downloadCSV()">Download</button>
							</center>
						</div>
					</div>
				</div>
		    </div>
		</div>


        <!-- Footer -->
		<footer class="footer">
			<div class="container text-center">
				<div class="d-flex justify-content-center align-items-center">
					<a href="#"><img src="../static/images/UMSNH.png" alt="UMSNH Logo" class="footer-image" /></a>
					<a href="#"><img src="../static/images/CONAHCYT.png" alt="CONAHCYT Logo" class="footer-image" /></a>
					<a href="#"><img src="../static/images/IngeIA.png" alt="IngeIA Logo" class="footer-image" /></a>
				</div>
				<p class="mt-3">&copy; CloudGen. All rights reserved.</p>
			</div>
		</footer>
    </body>
</html>
